(()=>{var ce=Object.defineProperty,de=Object.defineProperties;var le=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable;var C=(t,e,n)=>e in t?ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,_=(t,e)=>{for(var n in e||(e={}))ue.call(e,n)&&C(t,n,e[n]);if(F)for(var n of F(e))ge.call(e,n)&&C(t,n,e[n]);return t},j=(t,e)=>de(t,le(e));var h=(t,e,n)=>C(t,typeof e!="symbol"?e+"":e,n);var g=(t,e,n)=>new Promise((r,o)=>{var s=a=>{try{c(n.next(a))}catch(p){o(p)}},d=a=>{try{c(n.throw(a))}catch(p){o(p)}},c=a=>a.done?r(a.value):Promise.resolve(a.value).then(s,d);c((n=n.apply(t,e)).next())});function P(){return`10000000-1000-4000-8000-${1e11}`.replace(/[018]/g,t=>{let e=crypto.getRandomValues(new Uint8Array(1))[0];return(+t^e&15>>+t/4).toString(16)})}var z=t=>{let e=/^[a-fA-F0-9]+$/,n=t.length;return!!({32:"MD5",40:"SHA-1",64:"SHA-256",128:"SHA-512"}[n]&&e.test(t))};function N(t,e=!0){return g(this,null,function*(){if(!t)return"";e&&(t=t.toLowerCase());let n=new TextEncoder().encode(t),r=yield window.crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(r)).map(d=>d.toString(16).padStart(2,"0")).join("")})}var A=()=>/Safari/i.test(window.navigator.userAgent)&&!/Chrome/i.test(window.navigator.userAgent);function x(t,e){let n=e.split("&");for(let r=0;r<n.length;r++){let o=n[r].split("=");if(o[0]===t)return o[1]}return null}function K(){let t=localStorage.getItem("gpuInfo");if(t)try{return JSON.parse(t)}catch(c){}let e=document.createElement("canvas"),n=null;for(let c of["webgl2","webgl","experimental-webgl"])try{let a=e.getContext(c);if(a&&(a instanceof WebGLRenderingContext||a instanceof WebGL2RenderingContext)){n=a;break}}catch(a){}if(!n)return null;let r="N/A",o="N/A",s=n.getExtension("WEBGL_debug_renderer_info");try{s?(r=n.getParameter(s.UNMASKED_VENDOR_WEBGL)||"N/A",o=n.getParameter(s.UNMASKED_RENDERER_WEBGL)||"N/A"):(r=n.getParameter(n.VENDOR)||"N/A",o=n.getParameter(n.RENDERER)||"N/A")}catch(c){}let d={vendor:r,renderer:o};return localStorage.setItem("gpuInfo",JSON.stringify(d)),d}var M=t=>Object.entries(t).map(([e,n])=>(n&&typeof n=="object"&&(n=JSON.stringify(n)),`${e}=${encodeURIComponent(n)}`)).join("&");function R(t,e,n="",r,o=!1){if(e==null)return;let s=[];s.push(`${t}=${e}`),n&&s.push(`expires=${n}`),s.push("path=/"),r&&s.push(`domain=${r}`),s.push("SameSite=Lax"),o&&s.push("Secure"),document.cookie=s.join(";")}function w(t){try{let e=document.cookie.split("; ").find(r=>r.startsWith(`${t}=`));return e?e.split("=")[1]:""}catch(e){return""}}function v(t,e,n,r=null){if(e==null)return;let o;r?o=r:(o=new Date,o.setMonth(o.getMonth()+1));let d=n.replace("www.","").split(".");if(d.length===1){R(t,e,o.toUTCString(),void 0,!0);return}let c=`.${d.slice(-2).join(".")}`;R(t,e,o.toUTCString(),c,!0),!w(t)&&d.length>2&&(c=`.${d.slice(-3).join(".")}`,R(t,e,o.toUTCString(),c,!0)),A()&&localStorage&&localStorage.setItem(t,e)}var G="user_email_hash",$="user_email",m="ndclid",T="ndp_session_id",D="advertiser_pixel_test_id",W=["order_value","product_context","order_id"],Y=["email","phone_number","first_name","last_name","gender","street_address","city","state","zip_code","country"];var Q="Manual",k="https://flask.nextdoor.com/pixel",X="https://flask.nextdoor.com/pixel-test";var U=class{constructor(){h(this,"pseudoMappings",{":nth-of-type(":":t(",":nth-last-child(":":l(",":nth-last-of-type(":":lt(",":nth-child(":":n("});h(this,"reverseMappings",this.buildReverseMappings());h(this,"regexCache",new Map)}buildReverseMappings(){let e={};for(let[n,r]of Object.entries(this.pseudoMappings))e[r]=n;return e["|"]=" ",e}getOrCreateRegex(e){this.regexCache.has(e)||this.regexCache.set(e,new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"));let n=this.regexCache.get(e);if(!n)throw new Error("Failed to create regex pattern");return n}toDSL(e){if(!e||e.trim()==="")return e;let n=e.trim();for(let[r,o]of Object.entries(this.pseudoMappings)){let s=this.getOrCreateRegex(r);n=n.replace(s,o)}return n=n.replace(/\s+/g,"|"),n=n.replace(/\s+/g,""),n}fromDSL(e){if(!e||e.trim()==="")return e;let n=e.trim(),r=Object.entries(this.pseudoMappings).map(([o,s])=>[s,o]).sort(([o],[s])=>s.length-o.length);for(let[o,s]of r)n=n.replace(new RegExp(o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),s);return n=n.replace(/\|/g," "),n}isValidDSL(e){return!e||e.trim()===""?!1:!/[$%^&*()_+={}[\]|\\:;"'<>?,./]/.test(e)}},$e=new U;var fe=0;function S(){return Date.now()<fe}var J=new Set;function O(t){let e={promise:t.catch(()=>{}),timestamp:Date.now()};return J.add(e),t.finally(()=>{J.delete(e)}),t}var l={debug:(...t)=>{},info:(...t)=>{},warn:(...t)=>{},error:(...t)=>{}},b=!1;if(typeof document!="undefined")try{document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":b=!1,l.debug("[http] document visible: disable beacon-friendly transport");break;case"hidden":b=!0,l.debug("[http] document hidden: enable beacon-friendly transport");break;default:b=!1}})}catch(t){}if(typeof window!="undefined")try{window.addEventListener("pagehide",()=>{b=!0,l.debug("[http] pagehide fired: enable beacon-friendly transport")}),window.addEventListener("pageshow",()=>{b=!1,l.debug("[http] pageshow fired: disable beacon-friendly transport")})}catch(t){}function pe(t){if(typeof t=="string")return t;try{return new URLSearchParams(t).toString()}catch(e){return String(t!=null?t:"")}}function H(t,e){return g(this,null,function*(){return typeof fetch!="function"?!1:(l.debug("[http] fetch keepalive attempt",{url:t,init:e}),fetch(t,e).then(()=>(l.debug("[http] fetch keepalive sent",{method:(e==null?void 0:e.method)||"GET",url:t,keepalive:(e==null?void 0:e.keepalive)===!0,pageHidden:b}),!0)).catch(n=>(l.debug("fetch keepalive failed:",n),!1)))})}function he(t,e=1500){return l.debug("[http] using image fallback",{url:t,timeoutMs:e}),new Promise(n=>{try{let r=we(t),o=!1,s=()=>{o||(o=!0,n())},d=setTimeout(s,e);r.onload=()=>{clearTimeout(d),s()},r.onerror=()=>{clearTimeout(d),s()}}catch(r){n()}})}function me(t,e,n="POST"){return l.debug("[http] using XHR fallback",{url:t,method:n}),new Promise(r=>{try{let o=new XMLHttpRequest;o.open(n,t),o.withCredentials=!0,o.onreadystatechange=function(){o.readyState===4&&(o.status!==204&&l.debug(`Request failed to ${t}.`),r())},o.onerror=()=>r(),n==="POST"?o.send(e!=null?e:""):o.send()}catch(o){r()}})}var be=(t,e)=>g(null,null,function*(){let n=e||k,r=g(null,null,function*(){if(l.debug("[http] POST requested",{src:n}),(b||S())&&typeof navigator!="undefined"&&"sendBeacon"in navigator)try{let s=new Blob([JSON.stringify(t)],{type:"application/json"}),d=navigator.sendBeacon(n,s);l.debug("[http] POST via sendBeacon",{ok:d,pageHidden:!0,preferBeacon:S()});return}catch(s){l.debug("[http] POST beacon failed, continue to fetch/xhr",s)}if(yield H(n,{method:"POST",mode:"no-cors",credentials:"include",keepalive:!0,body:JSON.stringify(t)})){l.debug("[http] POST using fetch keepalive");return}return l.debug("[http] POST falling back to XHR"),me(n,JSON.stringify(t),"POST").catch(()=>{})});return O(r)}),we=t=>{let e=document.createElement("img");return e.src=t,e.alt="",e.style.display="none",e},ve=(t,e)=>g(null,null,function*(){let n=e||k,r=pe(t),o=`${n}?${r}`,s=g(null,null,function*(){if(l.debug("[http] GET requested",{src:o}),(b||S())&&typeof navigator!="undefined"&&"sendBeacon"in navigator)try{let c=new Blob([r],{type:"application/x-www-form-urlencoded"}),a=navigator.sendBeacon(n,c);l.debug("[http] GET via sendBeacon (POST form body)",{ok:a,pageHidden:!0,preferBeacon:S()});return}catch(c){l.debug("[http] GET beacon failed, continue to fetch/img",c)}if(S()&&(yield H(n,{method:"POST",mode:"no-cors",credentials:"include",keepalive:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r}))){l.debug("[http] GET request sent as POST keepalive due to critical window");return}if(yield H(o,{method:"GET",mode:"no-cors",credentials:"include",keepalive:!0})){l.debug("[http] GET using fetch keepalive");return}return l.debug("[http] GET falling back to IMG"),he(o,1500).catch(()=>{})});return O(s)}),Z=(t,e,n)=>g(null,null,function*(){l.debug("[http] execute called",{method:e,endpoint:n});let r;switch(e){case"POST":r=be(t,n);break;case"GET":r=ve(t,n);break;default:return}return r.catch(()=>{})});var ee="10.15";var f=class f{constructor(){h(this,"config");let e=f.DEBUG_FLAG_KEY,n=null;try{let a=localStorage.getItem(f.STORAGE_LEVEL_KEY);if(a){let p=JSON.parse(a);Date.now()-p.ts<3e5?n=p.level:localStorage.removeItem(f.STORAGE_LEVEL_KEY)}}catch(a){}let r=(()=>{try{return localStorage.getItem(e)==="1"}catch(a){return!1}})(),o=(()=>{try{return new URLSearchParams(window.location.search).get(e)==="1"}catch(a){return!1}})(),s=(()=>{try{let a=localStorage.getItem(f.STORAGE_OPTS_KEY);return a?JSON.parse(a):null}catch(a){return null}})(),d=r||n&&n!=="off"||o,c=n&&n!=="off"?n:r||o?"debug":"error";this.config={enabled:d,level:d?c:"error",prefix:"[Nextdoor Pixel]",includeTimestamp:!!(s!=null&&s.includeTimestamp),includeLocation:!!(s!=null&&s.includeLocation)}}formatPrefix(e){let n=[this.config.prefix,`[${e.toUpperCase()}]`];if(this.config.includeTimestamp)try{n.push(new Date().toISOString())}catch(r){}if(this.config.includeLocation){let r=this.getCallerLocation();r&&n.push(`(${r})`)}return n.join(" ")}getCallerLocation(){try{let e=new Error;if(!e.stack)return null;let n=e.stack.split(`
`).map(r=>r.trim());for(let r=1;r<n.length;r++){let o=n[r];if(!o||o.includes("basic/logger"))continue;let s=o.match(/\(?([^()]+):(\d+):(\d+)\)?$/);if(s){let d=s[1],c=s[2];return`${d}:${c}`}}return null}catch(e){return null}}shouldLog(e){if(!this.config.enabled)return!1;let n=["debug","info","warn","error"],r=n.indexOf(this.config.level);return n.indexOf(e)>=r}debug(e,...n){this.shouldLog("debug")&&(console.groupCollapsed(`${this.formatPrefix("debug")} ${e}`,...n),console.trace(),console.groupEnd())}info(e,...n){this.shouldLog("info")&&console.log(`${this.formatPrefix("info")} ${e}`,...n)}warn(e,...n){this.shouldLog("warn")&&console.warn(`${this.formatPrefix("warn")} ${e}`,...n)}error(e,...n){this.shouldLog("error")&&console.error(`${this.formatPrefix("error")} ${e}`,...n)}enableDebug(){this.config.enabled=!0,this.config.level="debug";try{localStorage.setItem("ndp_debug","1");let e={level:"debug",ts:Date.now()};localStorage.setItem(f.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}console.log(`${this.config.prefix} Debug mode enabled`)}disable(){this.config.enabled=!1;try{localStorage.removeItem("ndp_debug");let e={level:"off",ts:Date.now()};localStorage.setItem(f.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}}setLevel(e){if(e==="off")this.disable();else{this.config.enabled=!0,this.config.level=e;try{let n={level:e,ts:Date.now()};localStorage.setItem(f.STORAGE_LEVEL_KEY,JSON.stringify(n))}catch(n){}console.log(`${this.config.prefix} Log level set to '${e}'`)}}setOptions(e){try{typeof e.includeTimestamp=="boolean"&&(this.config.includeTimestamp=e.includeTimestamp),typeof e.includeLocation=="boolean"&&(this.config.includeLocation=e.includeLocation);let n={includeTimestamp:this.config.includeTimestamp,includeLocation:this.config.includeLocation};localStorage.setItem(f.STORAGE_OPTS_KEY,JSON.stringify(n)),console.log(`${this.config.prefix} Log options updated`,n)}catch(n){}}};h(f,"STORAGE_LEVEL_KEY","ndp_log_level"),h(f,"DEBUG_FLAG_KEY","ndp_debug"),h(f,"STORAGE_OPTS_KEY","ndp_log_opts");var I=f,u=new I;typeof window!="undefined"&&(window.ndpDebug=()=>(u.enableDebug(),"Nextdoor Pixel debug mode enabled. Check console for detailed logs."),window.ndpLog=t=>(u.setLevel(t),`Nextdoor Pixel log level set to '${t}'.`),window.ndpLogOptions=t=>(u.setOptions(t),"Nextdoor Pixel log options updated."),window.ndpReset=t=>{try{let e=[],n=()=>{try{localStorage.removeItem(I.DEBUG_FLAG_KEY)}catch(o){}try{localStorage.removeItem(I.STORAGE_LEVEL_KEY)}catch(o){}u.disable(),e.push("debug flags")},r=()=>{try{sessionStorage.removeItem("ndp_settings")}catch(o){}try{sessionStorage.removeItem("ndp_settings_expiry")}catch(o){}e.push("settings cache")};if(t)t==="debug"?n():t==="setting"&&r();else{n();try{localStorage.removeItem("gpuInfo")}catch(o){}try{localStorage.removeItem("ndp_session_id")}catch(o){}try{localStorage.removeItem("ndclid")}catch(o){}r(),e.push("gpuInfo","ndp_session_id","ndclid")}return`Nextdoor Pixel reset completed: ${e.join(", ")||t||"none"}`}catch(e){return"Nextdoor Pixel reset encountered an error (see console)."}});var i={ev:"",v:0,handleRequest:()=>{},ndclid:"",pid:"",pixelIdList:[],pl:"",cd:{},processQueue:()=>{},queue:[[]],rf:"",sem:"",ndclid_src:0,tz:"",screenWidth:0,screenHeight:0,gpuVendor:"",gpuRenderer:"",rdu:void 0,rduco:void 0,rdust:void 0},Ee=t=>g(null,null,function*(){let e={};if(t){Object.entries(t).filter(([a])=>W.includes(a)).forEach(([a,p])=>{e[a]=p});let c=Object.entries(t).filter(([a])=>Y.includes(a));if(c.length>0){let a=c.map(ae=>g(null,[ae],function*([E,L]){return z(L)?[E,L]:N(L).then(B=>[E,B]).catch(B=>null)}));(yield Promise.allSettled(a)).forEach(E=>{if(E.status==="fulfilled"&&E.value){let[L,ae]=E.value;e[L]=ae}})}}let n=i.pixelIdList||[],r=null;if(window.NDPAdvancedMatching)for(let d of n){let c=window.NDPAdvancedMatching.getAdvancedMatchingInstance(d);if(c!=null&&c.isEnabled()){r=c;break}}if(u.debug("Checking advanced matching...",{hasAdvancedMatching:!!r,isEnabled:r==null?void 0:r.isEnabled()}),!r||!r.isEnabled())return u.debug("Advanced matching not available or not enabled. Empty custom data is sent."),e;u.debug("Getting advanced matching data...");let o=new Promise((d,c)=>setTimeout(()=>c(new Error("Advanced matching timeout")),2e3)),s=yield Promise.race([r.getProcessedData(),o]);return u.debug("Advanced matching data received:",s),s?(Object.entries(s).forEach(([d,c])=>{!e[d]&&c&&(e[d]=c)}),e):(u.debug("Advanced matching timeout"),{})}),xe=()=>((!i.pageURL||i.pageURL!==window.location.href)&&(i.pageId=P(),i.pageURL=window.location.href),i.pageId),Se=()=>{let t="";return A()&&localStorage&&(t=localStorage.getItem(T)),t||(w(T)?t=w(T):(t=P(),v(T,t,window.location.hostname))),t},Le=(t,e,n,r)=>g(null,null,function*(){let o=M(_(_(_(j(_({pid:t,vrs:ee,ev:e,pl:i.pl,v:i.v,ndclid:i.ndclid?i.ndclid:"",ndclid_src:i.ndclid_src||0,rf:i.rf,sem:i.sem||"",tm:i.sendPixelByGTM?"GTM":Q,iid:P(),pageid:xe(),sessionid:Se()},n&&n.event_id&&{eid:n.event_id}),{cd:yield Ee(r),tz:i.tz,sw:i.screenWidth||0,sh:i.screenHeight||0,gpuV:i.gpuVendor||"",gpuR:i.gpuRenderer||""}),i.rdu!==void 0&&{rdu:i.rdu}),i.rduco!==void 0&&{rduco:i.rduco}),i.rdust!==void 0&&{rdust:i.rdust})),d=_e()?X:k;i.sendPixelByGTM?i.sendPixelByGTM(`${d}?${o}`):yield Z(o,"GET",d)});function _e(){let t;if(t=w(D),t)return t;if(t=x(D,location.search.substring(1)),t){let e=new Date;return e.setMinutes(e.getMinutes()+10),v(D,t,window.location.hostname,e),t}return""}function te(t){let e;return e=x(m,location.search.substring(1)),e?(v(m,e,window.location.hostname),{ndclid:e,ndclid_src:1}):(e=x(m,decodeURIComponent(location.href)),e?(v(m,e,window.location.hostname),{ndclid:e,ndclid_src:1}):(e=x("ndclid",document.referrer),e?(v(m,e!=null?e:"",window.location.hostname),{ndclid:e,ndclid_src:1}):t.sendPixelByGTM&&t.getCookieValues&&([e]=t.getCookieValues(m),e)?{ndclid:e,ndclid_src:2}:A()&&localStorage&&(e=localStorage.getItem(m),e)?{ndclid:e,ndclid_src:2}:(e=w(m),e?{ndclid:e,ndclid_src:2}:{ndclid:"",ndclid_src:0})))}var ne=t=>{i.rf=document.referrer,i.tz=Intl.DateTimeFormat().resolvedOptions().timeZone||"",i.screenHeight=window.screen.height,i.screenWidth=window.screen.width;let e=K();e?(i.gpuVendor=e.vendor,i.gpuRenderer=e.renderer):(i.gpuVendor="",i.gpuRenderer=""),G in t?i.sem=t[G]:$ in t&&(i.em=t[$]),Object.assign(i,te(i))};function q(t,e,n){return g(this,null,function*(){if(typeof t=="string"&&(i.pl=location.href,crypto.subtle&&i.em&&!i.sem&&(i.sem=yield N(i.em)),t)){let r=i.pixelIdList;Array.isArray(e==null?void 0:e.pixel_ids)&&(r=e.pixel_ids,r.forEach(o=>{i.pixelIdList.indexOf(o)===-1&&i.pixelIdList.push(o)}));for(let o=0;o<r.length;o++){let s=r[o];yield Le(s,t,e,n)}}})}var y={};function oe(t){return g(this,null,function*(){let e="advancedMatching";if(y[e]){y[e]instanceof Promise&&(yield y[e]),yield re(t);return}y[e]=Pe();try{let n=yield y[e];y[e]=n,n&&(yield re(t))}catch(n){u.warn("Failed to load advanced matching module:",n),y[e]=!1}})}function Pe(){return new Promise(t=>{if(window.NDPAdvancedMatching){u.debug("Advanced matching module already loaded"),t(!0);return}let e=document.createElement("script"),n="js";e.src=`https://ads.nextdoor.com/v2/public/pixel/advmtch.${n}`,e.async=!0,e.onload=()=>{window.NDPAdvancedMatching?(u.debug("Advanced matching module loaded successfully"),t(!0)):(u.warn("Advanced matching module loaded but global not available"),t(!1))},e.onerror=r=>{u.warn("Failed to load advanced matching script:",r),t(!1)},document.head.appendChild(e),setTimeout(()=>{window.NDPAdvancedMatching||(u.warn("Advanced matching module load timeout"),t(!1))},1e4)})}function re(t){return g(this,null,function*(){if(!window.NDPAdvancedMatching){u.warn("Advanced matching module not available for initialization");return}try{(yield window.NDPAdvancedMatching.initAdvancedMatching(t))?u.debug("Advanced matching initialized successfully",{dataSourceId:t}):u.debug("Advanced matching initialization returned null (likely disabled)",{dataSourceId:t})}catch(e){u.warn("Advanced matching initialization failed:",e)}})}var Ae=(t,e)=>g(null,null,function*(){i.pixelIdList.indexOf(t)===-1&&i.pixelIdList.push(t),ne(e),yield oe(t)}),Te=(t,e,n)=>{t!==void 0&&(i.rdu=t),e!==void 0&&(i.rduco=e),n!==void 0&&(i.rdust=n)},ke=t=>{t&&typeof t=="string"&&(i.ndclid=t,i.ndclid_src=1)},Ie=t=>{let[e,...n]=t;if(!(!e||typeof e!="string")){for(;n.length<3;)n.push({});switch(e.toLowerCase()){case"init":{let[r,o]=n;return Ae(r,o)}case"track":{let[r,o,s]=n;return q(r,o,s)}case"restricteddatausage":{let[r,o,s]=n;return Te(r,o,s)}case"ndclid":{let[r]=n;return ke(r)}default:break}}},ie=()=>{if(Array.isArray(i.queue)&&i.queue.length>0){let t=i.queue.shift();if(t){let e=[...t];Ie(e),i.processQueue()}}},V=(...t)=>{i.queue.push(t),i.processQueue()};var Re=(t,e)=>{var n;return t.ndp&&Object.assign(i,t.ndp),i.v=i.v||((n=t.ndp)==null?void 0:n.v),i.pixelIdList=i.pixelIdList||[],i.processQueue=ie,i.handleRequest=V,t.ndp=V,{processQueue:i.processQueue}},se=Re;try{se(window,document).processQueue()}catch(t){console.log(t),console.log("Problem with request")}})();
